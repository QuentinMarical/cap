name: Code Quality Checks

on:
  push:
    branches: [ master, main, develop ]
    paths:
      - 'lua/**'
      - '.github/workflows/lint.yml'
  pull_request:
    branches: [ master, main, develop ]
    paths:
      - 'lua/**'

jobs:
  lua-syntax:
    name: Lua Syntax Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Lua
        uses: leafo/gh-action-lua@v10
        with:
          luaVersion: "5.1"
      
      - name: Install luacheck
        run: |
          sudo apt-get update
          sudo apt-get install -y luarocks
          sudo luarocks install luacheck
      
      - name: Run Lua syntax check
        run: |
          find lua -name "*.lua" -type f | head -20 | xargs luacheck --std gmod --globals love
        continue-on-error: true
      
      - name: Check for deprecated APIs
        run: |
          echo "Checking for deprecated SetNetworked* patterns..."
          if grep -r "SetNetworked" lua/ 2>/dev/null; then
            echo "‚ùå Found SetNetworked* (deprecated) - use SetNW* instead"
            exit 1
          fi
          echo "‚úÖ No SetNetworked* found"
        continue-on-error: true

  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Check required documentation files
        run: |
          required_files=(
            "README.md"
            "CHANGELOG.md"
            "CONTRIBUTING.md"
            "LICENSE.md"
            "SECURITY.md"
            "E2_GUIDE.md"
            "CODE_OF_CONDUCT.md"
          )
          
          missing=0
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "‚ùå Missing: $file"
              ((missing++))
            else
              echo "‚úÖ Found: $file"
            fi
          done
          
          if [ $missing -gt 0 ]; then
            echo "Missing $missing required documentation files"
            exit 1
          fi
      
      - name: Check addon.json validity
        run: |
          if ! command -v jq &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi
          
          if [ -f "addon.json" ]; then
            if jq empty addon.json 2>/dev/null; then
              echo "‚úÖ addon.json is valid JSON"
            else
              echo "‚ùå addon.json is invalid JSON"
              exit 1
            fi
          fi

  file-structure:
    name: File Structure Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Verify required directories
        run: |
          required_dirs=(
            "lua"
            "examples"
            ".github/ISSUE_TEMPLATE"
          )
          
          missing=0
          for dir in "${required_dirs[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "‚ùå Missing directory: $dir"
              ((missing++))
            else
              echo "‚úÖ Found directory: $dir"
            fi
          done
          
          if [ $missing -gt 0 ]; then
            exit 1
          fi
      
      - name: Check for temp/log files
        run: |
          echo "Checking for temporary or log files..."
          found=0
          
          patterns=("*.log" "*.tmp" "*.bak" "*.swp" "*~")
          for pattern in "${patterns[@]}"; do
            if find . -name "$pattern" -type f 2>/dev/null | grep -q .; then
              echo "‚ùå Found temp file pattern: $pattern"
              ((found++))
            fi
          done
          
          if [ $found -gt 0 ]; then
            exit 1
          fi
          echo "‚úÖ No temporary files found"

  example-scripts:
    name: E2 Example Scripts Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Verify E2 scripts
        run: |
          if [ -d "examples" ]; then
            count=$(find examples -name "*.txt" -type f | wc -l)
            echo "Found $count E2 script files"
            
            if [ $count -lt 7 ]; then
              echo "‚ö†Ô∏è  Warning: Less than expected E2 scripts"
            else
              echo "‚úÖ All expected E2 scripts present"
            fi
            
            # Check each script for required header
            find examples -name "*.txt" -type f | while read file; do
              if head -5 "$file" | grep -q "@name"; then
                echo "‚úÖ $file has proper header"
              else
                echo "‚ö†Ô∏è  $file may be missing proper E2 header"
              fi
            done
          fi

  summary:
    name: Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [lua-syntax, documentation, file-structure, example-scripts]
    steps:
      - name: Print Summary
        run: |
          echo "üìä Quality Check Summary"
          echo "========================"
          echo "All checks completed!"
          echo ""
          echo "For more information, check the individual job results above."
